---
layout: post
title: 🎒Spring framework - Mybatis
date: 2020-11-01 22:13:00
author: 'SeWonKim'
categories: [Java]
tags: [jekyll, TIL, Java, web, spring, mybatis]
fullview: false
comments: true
description: Spring Mybatis 연동
---

MVC 패턴에서 시작

## DAO

DAO의 역할 : DB와 연결

### JDBC 사용

1. Driver 로딩
2. connect
3. sql문 작성
4. sql문 실행
5. connect 끊기

## Mybatis...?

Mybatis를 사용함으로써 java 코드 쿼리문을 분리할 수 있다.     
Mybatis가 java와 SQL문(별도의 파일로 분리) 사이의 자동 Mapping을 지원한다.
sql문 작성하는 것을 제외하고 나머지 과정을 Mybatis를 사용해 자동화 시켜서 메소드의 길이를 많이 줄일 수 있다.


- 익숙한 SQL을 그대로 이용
- JDBC 코드 작성의 불편함을 줄여줌
- SQL문과 java 코드의 분리
- SQL 관리 및 검토를 다른 사람에게 맡길 수 있음

---

# Mybatis 사용법

>[mybatis docs](https://mybatis.org/mybatis-3/ko/index.html)

### 1. pom.xml에 추가

maven 을 사용하므로 pom.xml에 mybatis 라이브러리를 추가한다.

```xml
<!-- https://mvnrepository.com/artifact/org.mybatis/mybatis -->
<dependency>
	<groupId>org.mybatis</groupId>
	<artifactId>mybatis</artifactId>
	<version>3.5.3</version>
</dependency>
<!-- https://mvnrepository.com/artifact/org.mybatis/mybatis-spring -->
<dependency>
	<groupId>org.mybatis</groupId>
	<artifactId>mybatis-spring</artifactId>
	<version>2.0.3</version>
</dependency>
```

mybatis와 mybatis-spring

### 2. Mapper 설정 xml 


```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration PUBLIC "-//mybatis.org//DTD Config 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-config.dtd">
	
<configuration>

    <!-- 변수들을 properties에서 가져온다. 변수 직접 입력하려면 이거 사용안해도 무방 -->
	<properties resource="dbinfo.properties"/>

    <!-- type alias로 mapper에서 코드 길이를 줄이기! 사용안해도 무방 -->
	<typeAliases>
		<typeAlias type="com.ssafy.guestbook.model.GuestBookDto" alias="guestbook" />
		<typeAlias type="com.ssafy.guestbook.model.MemberDto" alias="member" />
	</typeAliases>
	
    <!-- DB 연결 -->
	<environments default="development">
        <environment id="development">
            <transactionManager type="JDBC"/>
            <dataSource type="POOLED">
                <property name="driver" value="${driver}"/>
                <property name="url" value="${url}"/>
                <property name="username" value="${dbid}"/>
                <property name="password" value="${dbpwd}"/>
            </dataSource>
        </environment>
    </environments>
    
    <!-- 연결할 SQL문이 어디있는지 알려준다 -->
    <mappers>
		<mapper resource="member.xml" />
		<mapper resource="guestbook.xml" />
	</mappers>
</configuration>
``` 


dbinfo.properties 파일 내용은 
```
driver=com.mysql.cj.jdbc.Driver
url=jdbc:mysql://localhost:3306/ssafyweb?serverTimezone=UTC&useUniCode=yes&characterEncoding=UTF-8
dbid=ssafy
dbpwd=ssafy
```
이런식으로 사용할 변수들을 저장해놓은 것

### 3. SqlSessionFactory 빌드

SqlSessionFactory는 sql문을 java 코드에서 사용할 수 있도록 바꿔주는 역할을 한다.

```java
public class SqlMapConfig {

private static SqlSessionFactory factory;
	
	static {
		try {
			String resource = "mybatis-config.xml";
			Reader reader = Resources.getResourceAsReader(resource);
			factory = new SqlSessionFactoryBuilder().build(reader);
		} catch (IOException e) {
			e.printStackTrace();
		}
	}

	public static SqlSession getSqlSession() {
		return factory.openSession(true);
	}
	
}
```
SqlMapConfig.java 파일에서 factory를 만들어준다.

### 4. 쿼리문 작성 xml

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.guestbook.model.dao.UserDao">

	<select id="login" parameterType="map" resultType="member">
		select username, userid, email
		from ssafy_member
		where userid = #{userid} and userpwd = #{userpwd}
	</select>
	
</mapper>
```

이 때 DOCTYPE 에 `mapper`임에 주의!    
config 파일은 `config`라고 되어있다.

- select, insert, update, delete
- id
- parameterType
- resultType (select만 있음)
- 파라미터 표기는 `#{파라미터}` 형태로
- if, foreach 등을 사용해 동적 sql 작성이 가능


### 5. DAO

Mybatis 연동한 프로젝트에는 DAO interface가 필요 없다.

```java
@Repository
public class UserDaoImpl implements UserDao {

	@Override
	public MemberDto login(Map<String, String> map) throws SQLException {
		try(SqlSession sqlSession = SqlMapConfig.getSqlSession()) {
			return sqlSession.selectOne("com.ssafy.guestbook.model.dao.UserDao.login", map);
		}
	}

}
```

아까 빌드한 factory에서 getSqlSession 메소드를 통해 SqlSession을 얻어온 후 쿼리 실행

### 🎇정리

mapper.xml + properties 파일 => `sqlConfig.xml` => `sqlSessionFactory` => sqlSession

- config.xml 파일; DB 접속 url이나 alias, mapping 파일의 경로 등 환경 정보 설정
- sqlSessionFactoryBuilder; config 파일을 바탕으로 sqlSessionFactory를 생성
- sqlSessionFactory; sqlSession 생성
- sqlSession; 🎇핵심🎇 SQL 실행

---

# Spring에 Mybatis 연결해서 사용하는 방법

1. spring lagacy project 생성
2. facets 변경
3. pom.xml: mybatis-spring 라이브러리 추가 
4. web.xml: 프로젝트에 대한 전채적인 설정 -> servlet-context.xml(web관련 설정) & root-context.xml(service, dao 관련 설정)
5. root-context.xml: mybatis 관련 설정 추가
6. mybatis-config.xml
7. sql 문 작성
8. Data 접근 객체 구현; daoImpl 사용하지 않고 dao interface만 사용

## pom.xml 

- mysql
- mybatis
- mybatis-spring
- commons-dbcp; connection poll 관련
- jackson-databind; rest api 수업관련, json 형식 사용

```xml
        <!-- https://mvnrepository.com/artifact/mysql/mysql-connector-java --> 
		<dependency>
			<groupId>mysql</groupId>
			<artifactId>mysql-connector-java</artifactId>
			<version>8.0.20</version>
		</dependency>
		
		<!-- https://mvnrepository.com/artifact/org.mybatis/mybatis -->
		<dependency>
			<groupId>org.mybatis</groupId>
			<artifactId>mybatis</artifactId>
			<version>3.5.3</version>
		</dependency>
		<!-- https://mvnrepository.com/artifact/org.mybatis/mybatis-spring -->
		<dependency>
			<groupId>org.mybatis</groupId>
			<artifactId>mybatis-spring</artifactId>
			<version>2.0.3</version>
		</dependency>
		<!-- https://mvnrepository.com/artifact/commons-dbcp/commons-dbcp -->
		<dependency>
			<groupId>commons-dbcp</groupId>
			<artifactId>commons-dbcp</artifactId>
			<version>1.4</version>
		</dependency>
		
		<!-- https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-databind -->
		<dependency>
			<groupId>com.fasterxml.jackson.core</groupId>
			<artifactId>jackson-databind</artifactId>
			<version>2.11.0</version>
		</dependency>
```

## root-context.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:tx="http://www.springframework.org/schema/tx"
	xsi:schemaLocation="http://www.springframework.org/schema/beans https://www.springframework.org/schema/beans/spring-beans.xsd
		http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-4.3.xsd">
	
	<!-- Root Context: defines shared resources visible to all other web components -->
	
    <!-- JndiObjectFactoryBean라이브러리를 사용해서 DataSource 설정 (META-INF 추가) -->
	<bean id="dataSource" class="org.springframework.jndi.JndiObjectFactoryBean">
		<property name="jndiName" value="java:comp/env/jdbc/ssafy"/>
	</bean>

    <!-- SqlSessionFactoryBean 생성 -->
	<bean id="sqlSessionFactoryBean" class="org.mybatis.spring.SqlSessionFactoryBean">
		<property name="dataSource" ref="dataSource"/>
        
        <!-- 설정파일 -->
		<property name="configLocation" value="classpath:mybatis-config.xml"/> 

        <!-- mapper 파일 -->
		<property name="mapperLocations">
			<list>
				<value>classpath:member.xml</value>
				<value>classpath:guestbook.xml</value>
			</list>
		</property>
	</bean>


	<!-- SqlSessionTemplate으로 sqlSession생성 -->
	<bean id="sqlSession" class="org.mybatis.spring.SqlSessionTemplate">
		<constructor-arg ref="sqlSessionFactoryBean"/>
	</bean>
	
    <!-- transaction 관리 -->
	<bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
		<property name="dataSource" ref="dataSource" />
	</bean>
	<tx:annotation-driven transaction-manager="transactionManager"/>
		
</beans>
```


## mybatis-config.xml

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration PUBLIC "-//mybatis.org//DTD Config 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-config.dtd">
	
<configuration>
	<typeAliases>
		<typeAlias type="com.ssafy.guestbook.model.GuestBookDto" alias="guestbook" />
		<typeAlias type="com.ssafy.guestbook.model.MemberDto" alias="member" />
	</typeAliases>
</configuration>

```

object 와 sql을 mappping 시켜주는 부분


## SQL문 작성

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.guestbook.model.mapper.UserDao">

	<select id="login" parameterType="map" resultType="member">
		select username, userid, email
		from ssafy_member
		where userid = #{userid} and userpwd = #{userpwd}
	</select>
	
</mapper>
```

## Data 접근 객체 구현

- @Repository 는 데이터 접근 객체를 bean으로 등록하기 위해 사용하는 annotation
- @Autowired 를 통해 사용하려는 Mapper interface를 데이터 접근 객체와 의존관계 설정

```java
public interface UserDao {
	public MemberDto login(Map<String, String> map) throws SQLException;
}
```

